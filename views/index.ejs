<%- include("partials/header-nav")%>
<script>
    console.log('Stylesheet:', document.querySelector('link[rel="stylesheet"]').href);
</script>
<!-- JS CALENDAR SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script>
    function changeWarehouse() {
      const selectedWarehouse = document.getElementById('location').value;
      window.location.href = `/home?warehouseId=${selectedWarehouse}`;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <script>
async function fetchProductsStockValue(warehouseId) {
  try {
    // 获取数据
    const response = await fetch(`/api/products-stock-value?warehouseId=${warehouseId}`);
    const data = await response.json();

    console.log("Data passed to Vega-Lite:", data);

    // 如果 data 为空，使用默认数据
    const chartData = (data.length ? data : [
      { title: "Product A", quantity: 100, price: 10 },
      { title: "Product B", quantity: 200, price: 15 },
      { title: "Product C", quantity: 300, price: 20 },
      { title: "Product D", quantity: 400, price: 25 },
      { title: "Product E", quantity: 500, price: 30 }
    ]).map(item => {
      item.revenue = item.quantity * item.price; // 动态计算 revenue
      return item;
    });

    // 渲染图表
    vegaEmbed("#voorraadOmzet", {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "description": "Voorraad Omzet Chart",
      "width": "container",
      "data": { "values": chartData },
      "selection": {
        "warehouseSelection": {
          "type": "multi",
          "fields": ["title"],
          "bind": "legend"
        }
      },
      "mark": {
        "type": "bar"
      },
      "encoding": {
        "x": {
          "field": "title",
          "type": "ordinal",
          "axis": null
        },
        "y": {
          "field": "quantity",
          "type": "quantitative",
          "axis": { "title": "Quantity" }
        },
        "color": {
          "field": "title",
          "type": "nominal",
          "legend": { "title": "Product" }
        },
        "opacity": {
          "condition": { "selection": "warehouseSelection", "value": 1 },
          "value": 0.2
        }
      }
    });
  } catch (error) {
    console.error("Error fetching or rendering data:", error);
  }
}

// 初始化加载
fetchProductsStockValue(0);
  
  /* 等api恢复 删掉注释。。。。。。。。。。。。。。。。111111111111111111111111111
async function fetchProductsStockValue(warehouseId) {
  try {
    const response = await fetch(`/api/products-stock-value?warehouseId=${warehouseId}`);
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }

    const data = await response.json();
    console.log(`Fetched data for warehouse ${warehouseId}:`, data);
    return data;

    if (!data.length) {
      console.error("No data available for chart.");
      return;
    }
    return data;

    vegaEmbed("#voorraadOmzet", {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Line chart showing incoming and outgoing shipments for different warehouses with interactive selection.",
    "width": "container",
    "data": {
        "values": data
    },
    "selection": {
        "warehouseSelection": {
            "type": "multi",
            "fields": ["title"],
            "bind": "legend"
        }
    },
    "mark": {
        "type": "bar",
    },
    "encoding": {
        "x": {
          "field": "title",
            "type": "ordinal",
            "axis": null 
        },
        "y": {
          "field": "quantity",
            "type": "quantitative",
            "axis": { "title": "Quantity" }
        },
        "color": {
          "field": "title",
            "type": "nominal",
            "legend": { "title": "Product" }
        },
        "opacity": {
            "condition": { "selection": "warehouseSelection", "value": 1 },
            "value": 0.2
        },
        "detail": {
            "field": "type",
            "type": "nominal"
        }
    }
    
});
  } catch (error) {
    console.error("Error fetching voorraad omzet data:", error);
  }
}
    
    function changeWarehouse() {
      const warehouseId = document.getElementById('location').value;
      fetchProductsStockValue(warehouseId);
    }
    
    fetchProductsStockValue(0);*/
    </script>
    
<section class="menu">
  <h1><%= stats.location %></h1>
  <section class="dropdowns">
    <select name="location" id="location" onchange="changeWarehouse()" <% if (user.role === 'TeamLeader') { %> style="display: none;" <% } %>>
      <% for (let w of warehouses) { %>
        <option value="<%= w.warehouse_id %>" <%= warehouseId == w.warehouse_id ? 'selected' : '' %> >
          <%= w.location %>
        </option>
      <% } %>
            <!--<option value="New York">New York</option>
            <option value="Los Angeles">Los Angeles</option>-->
        </select>
        <input type="text" id="date_range" placeholder="Selecteer Datumbereik" />
        <button onclick="filterData()">Filter</button>
        <script>
            flatpickr("#date_range", {
                mode: "range",
                dateFormat: "d-m-Y", // Set European date format
                locale: {
                    firstDayOfWeek: 1 // Start the week on Monday
                }
            });
    // Filter data based on date range
    function filterData() {
        const selectedWarehouse = document.getElementById('location').value;
        const dateRange = document.getElementById('date_range').value;

        if (!dateRange) {
            alert("Selecteer een datumbereik!");
            return;
        }

         const dates = dateRange.split(" to ");
         const startDate = dates[0];
         const endDate = dates[1] || startDate;

         window.location.href = `/home?warehouseId=${selectedWarehouse}&startDate=${startDate}&endDate=${endDate}`;
    }
        </script>
    </section>
</section>
<h1><%= startDate %> tot en met <%= endDate %></h1>
<article>
    <h2>Overview</h2>
<section class="firstrow">
    <div class="statcard">
        <i></i>
        <h2><%= stats.totalOrders %></h2>
        <p>Orders Verwerkt</p>
    </div>
    <div class="statcard">
        <i></i>
        <h2><%= stats.delayedOrders %></h2>
        <p>Orders Vertraagd</p>
    </div>
    <div class="statcard">
        <i></i>
        <h2><%= stats.onTimePercentage %>%</h2>
        <p>Orderverwerkingspercentage</p>
    </div>
    <div class="statcard">
        <i></i>
        <h2><%= stats.spaceUtilization %>%</h2>
        <p>Ruimtegebruik</p>
    </div>
</section>
</article>
<article>
    <h2>Voorraad Omzet</h2>
    <section class="secondrow">
        <div class="placeholder" id="voorraadOmzet"></div>
        <div class="statcard">
            <i></i>
            <h2><%= stats.turnoverRate %></h2>
            <p>Turnover rate</p>
        </div>
    </section>
</article>
<article>
    <h2>Meest Verkocht</h2>

    
    <section class="thirdrow">
      <div id="grid-js-table"></div>
      
        <div class="placeholder">
            <table id="product-table" border="1">
                <thead>
                    <tr>
                        <th>Product Image</th>
                        <th>Product ID</th>
                        <th>Product Name</th>
                        <th>Units Sold</th>
                        <th>Total Revenue</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be dynamically added here -->
                    <% for (let i = 0; i < 10; i++) { %>
                        <tr>
                            <td><img src="<%= productSalesData[i].image %>" alt="<%= productSalesData[i].title %>" width="100px"></td>
                            <td><%= productSalesData[i].id %></td>
                            <td><a href="<%= productSalesData[i].link %>"><%= productSalesData[i].title %></a></td>
                            <td><%= productSalesData[i].totalUnitsSold %></td>
                            <td><%= productSalesData[i].currency %> <%= productSalesData[i].totalRevenue %></td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
        </div>
        <div class="statcard">
            <p>Stock Level</p>
            <i></i>
            <h2 class="<%= productSalesData[0].totalUnitsSold > 30 ? 'low' : (productSalesData[0].totalUnitsSold >= 15 && productSalesData[0].totalUnitsSold <= 30 ? 'medium' : 'high') %>">
                <%= productSalesData[0].totalUnitsSold > 30 ? 'LOW' : (productSalesData[0].totalUnitsSold >= 15 && productSalesData[0].totalUnitsSold <= 30 ? 'MEDIUM' : 'HIGH') %>
            </h2>
            <p><%= productSalesData[0].title %></p>
        </div>
    </section>
</article>

<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
<script>
  const products = <%- JSON.stringify(productSalesData) %>;

// Format data for Grid.js
const gridData = products.map(product => [
  `<a href="${product.link}" target="_blank"><img src="${product.image}" alt="Product Image" width="50" /></a>`,
  product.id,
  `<a href="${product.link}" target="_blank">${product.title}</a>`,  
  product.totalUnitsSold,
  product.totalRevenue
]);

// Initialize Grid.js
new gridjs.Grid({
  columns: [
    {
      name: "Afbeelding",
      formatter: (cell) => gridjs.html(cell)
    },
    "Product ID",
    {
      name: "Naam",
      formatter: (cell) => gridjs.html(cell)
    },
    {
      name: "Verkochte eenheden",
      width: "100px"
    },
    "Totale Omzet"
  ],
  data: gridData,
  pagination: {
    enabled: true,
    limit: 10
  },
  sort: true,
  search: true,
  resizable: true,
  width: '80%',
  style: {
    th: {
      'background-color': '#0469C8',
      'color': '#FFF'
    }
  },
  language: {
    'search': {
      'placeholder': '🔍 Zoeken...'
    },
    'pagination': {
      'previous': 'Vorige',
      'next': 'Volgende',
      'showing': 'Afbeelden: ',
      'results': () => 'resultaten',
      'of': 'van',
      'to': 'tot',
    }
  },
  className: {
    table: 'grid-js-table'
  }
    }).render(document.getElementById("grid-js-table"));
</script>

<%- include("partials/doc-end")%>
</script>
<!-- CHART SCRIPTS  -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/js/dashboard-charts.js"></script>
